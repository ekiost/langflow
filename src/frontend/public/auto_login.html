<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Langflow Iframe Login Example</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 font-sans text-gray-800">
    <div class="mx-auto flex h-screen w-screen flex-col p-6">
      <h1 class="mb-6 text-center text-3xl font-bold">
        Langflow Iframe Login Example (This is Language Studio), User: testuser1
      </h1>
      <iframe
        id="langflowFrame"
        src="http://localhost:3000"
        title="Langflow"
        class="h-full w-full rounded-md border border-gray-300"
      ></iframe>
    </div>

    <script>
      const iframe = document.getElementById("langflowFrame");
      const langflowOrigin = "http://localhost:3000";

      // These are the credentials to be sent to the iframe
      const credentials = {
        username: "testuser2",
        password: "testpass",
      };

      // 1. Listen for the 'ready' message from the iframe
      window.addEventListener("message", (event) => {
        // IMPORTANT: Verify the message is from our trusted iframe
        if (event.origin !== langflowOrigin) {
          return;
        }

        // 2. Check if the message type is what we expect
        if (event.data.type === "ready") {
          console.log(
            "Parent received 'ready' signal from iframe. Sending credentials.",
          );

          // 3. Send a POST request to the backend to create a user
          fetch("http://localhost:3000/api/v1/users/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              username: credentials.username,
              password: credentials.password,
            }),
          })
            // 4. Handle the response from the backend
            .then((response) => {
              if (!response.ok) {
                return response.json().then((error) => {
                  // Log the full error for debugging
                  console.error("Backend error:", error.detail);
                  iframe.contentWindow.postMessage(
                    {
                      type: "credentials",
                      credentials: credentials,
                    },
                    langflowOrigin, // Target the iframe's origin
                  );
                });
              }
              return response.json();
            })
            .then((data) => {
              console.log("User created successfully:", data);
              // 5. Send the credentials to the iframe
              iframe.contentWindow.postMessage(
                {
                  type: "credentials",
                  credentials: credentials,
                },
                langflowOrigin, // Target the iframe's origin
              );
            });
        }
      });
    </script>
  </body>
</html>
